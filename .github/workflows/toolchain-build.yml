name: GCC Build

on:
  workflow_dispatch:
    branches: [ main ]
  schedule:
    - cron: '0 00 * * SAT'

env:
      GITHUB_EMAIL: ${{ secrets.EMAIL }}
      GITHUB_TOKEN: ${{ secrets.API_TOKEN_GITHUB }}
      GITHUB_USER: ${{ secrets.USERNAME }}

jobs:
  build-arm64-tc:
    runs-on: ubuntu-latest
    container:
      image: mhmmdfdlyas/dockerfile:t-ubuntu

    steps:
    - uses: actions/checkout@v4
    - name: Build
      run: |
        git clone https://${GITHUB_TOKEN}@github.com/greenforce-project/gcc-arm64 -b main --depth=1
        chmod a+x build-*.sh
        ./build-gcc.sh -a arm64
        script_dir=$(pwd)
        cd gcc-arm64
        ./bin/aarch64-elf-gcc -v 2>&1 | tee ../gcc-version
        ./bin/aarch64-elf-ld -v 2>&1 | tee ../ld-version
        bash "$script_dir/strip-binaries.sh"
        git add . -f
        touch ../git_commit
        {
            echo "GCC version: $(cat ../gcc-version | grep 'gcc version')"
            echo "Binutils version: $(cat ../ld-version | head -n1)"
            echo "GCC repo commit: $(cat /tmp/gcc_commit)"
            echo "Link: https://github.com/gcc-mirror/gcc/commit/$(cat /tmp/gcc_hash)"
        } > ../git_commit
        git commit -m "greenforce: Bump to $(date +'%d%m%Y') build" -m "$(cat ../git_commit)" -s
        git push -f

  build-arm-tc:
    runs-on: ubuntu-latest
    container:
      image: mhmmdfdlyas/dockerfile:t-ubuntu

    steps:
    - uses: actions/checkout@v4
    - name: Build
      run: |
        git clone https://${GITHUB_TOKEN}@github.com/greenforce-project/gcc-arm -b main --depth=1
        chmod a+x build-*.sh
        ./build-gcc.sh -a arm
        script_dir=$(pwd)
        cd gcc-arm
        ./bin/arm-eabi-gcc -v 2>&1 | tee ../gcc-version
        ./bin/arm-eabi-ld -v 2>&1 | tee ../ld-version
        bash "$script_dir/strip-binaries.sh"
        git add . -f
        touch ../git_commit
        {
            echo "GCC version: $(cat ../gcc-version | grep 'gcc version')"
            echo "Binutils version: $(cat ../ld-version | head -n1)"
            echo "GCC repo commit: $(cat /tmp/gcc_commit)"
            echo "Link: https://github.com/gcc-mirror/gcc/commit/$(cat /tmp/gcc_hash)"
        } > ../git_commit
        git commit -m "greenforce: Bump to $(date +'%d%m%Y') build" -m "$(cat ../git_commit)" -s
        git push -f
