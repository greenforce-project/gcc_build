name: GCC Build

on:
  workflow_dispatch:
    branches: [ main ]
  schedule:
    - cron: '0 00 * * SAT'

env:
      TZ: Asia/Jakarta
      GITHUB_EMAIL: ${{ secrets.EMAIL }}
      GITHUB_TOKEN: ${{ secrets.API_TOKEN_GITHUB }}
      GITHUB_USER: ${{ secrets.USERNAME }}

jobs:
  build-arm64-tc:
    runs-on: ubuntu-latest
    container:
      image: mhmmdfdlyas/dockerfile:t-ubuntu

    steps:
    - uses: actions/checkout@v4
    - name: Setup git config and hooks
      run: |
        git config --global user.name "$GITHUB_USER"
        git config --global user.email "$GITHUB_EMAIL"
        mkdir -p ~/.git/hooks
        git config --global core.hooksPath ~/.git/hooks
        curl -Lo ~/.git/hooks/commit-msg https://review.lineageos.org/tools/hooks/commit-msg
        chmod u+x ~/.git/hooks/commit-msg

    - name: Build
      run: |
        git clone https://${GITHUB_TOKEN}@github.com/greenforce-project/gcc-arm64 -b main gcc-arm64gnu --depth=1
        chmod a+x build-*.sh
        ./build-gcc.sh -a arm64gnu
        script_dir=$(pwd)
        cd gcc-arm64gnu
        ./bin/aarch64-linux-gnu-gcc -v 2>&1 | tee ../gcc-version
        ./bin/aarch64-linux-gnu-ld -v 2>&1 | tee ../ld-version
        bash "$script_dir/strip-binaries.sh"
        git add . -f
        touch ../git_commit
        {
            echo "GCC version: $(cat ../gcc-version | grep 'gcc version')"
            echo "Binutils version: $(cat ../ld-version | head -n1)"
            echo "GCC repo commit: $(cat /tmp/gcc_commit)"
            echo "Link: https://github.com/gcc-mirror/gcc/commit/$(cat /tmp/gcc_hash)"
        } > ../git_commit
        git commit -m "greenforce: Bump to $(date +'%d%m%Y') build" -m "$(cat ../git_commit)" -s
        git push -f

  build-arm-tc:
    runs-on: ubuntu-latest
    container:
      image: mhmmdfdlyas/dockerfile:t-ubuntu

    steps:
    - uses: actions/checkout@v4
    - name: Setup git config and hooks
      run: |
        git config --global user.name "$GITHUB_USER"
        git config --global user.email "$GITHUB_EMAIL"
        mkdir -p ~/.git/hooks
        git config --global core.hooksPath ~/.git/hooks
        curl -Lo ~/.git/hooks/commit-msg https://review.lineageos.org/tools/hooks/commit-msg
        chmod u+x ~/.git/hooks/commit-msg

    - name: Build
      run: |
        git clone https://${GITHUB_TOKEN}@github.com/greenforce-project/gcc-arm -b main gcc-armgnu --depth=1
        chmod a+x build-*.sh
        ./build-gcc.sh -a armgnu
        script_dir=$(pwd)
        cd gcc-armgnu
        ./bin/arm-linux-gnueabi-gcc -v 2>&1 | tee ../gcc-version
        ./bin/arm-linux-gnueabi-ld -v 2>&1 | tee ../ld-version
        bash "$script_dir/strip-binaries.sh"
        git add . -f
        touch ../git_commit
        {
            echo "GCC version: $(cat ../gcc-version | grep 'gcc version')"
            echo "Binutils version: $(cat ../ld-version | head -n1)"
            echo "GCC repo commit: $(cat /tmp/gcc_commit)"
            echo "Link: https://github.com/gcc-mirror/gcc/commit/$(cat /tmp/gcc_hash)"
        } > ../git_commit
        git commit -m "greenforce: Bump to $(date +'%d%m%Y') build" -m "$(cat ../git_commit)" -s
        git push -f
